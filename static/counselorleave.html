<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>学生请假审核</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Excel导出依赖库 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #fefefe;
      --card: #ffffff;
      --text: #1e293b;
      --border: #e2e8f0;
    }
    body {
      background-color: var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .card { background: var(--card); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .input-base {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: all 0.3s;
      background-color: var(--card);
    }
    .input-base:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #059669; transform: translateY(-1px); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #dc2626; transform: translateY(-1px); }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { background: #f8fafc; }
    .badge { padding: 4px 8px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .table-row:hover { background: #f8fafc; }
    .glass {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid rgba(226, 232, 240, 0.5);
    }
    .status-badge { display: inline-flex; align-items: center; gap: 4px; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .nav-btn {
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      background: white;
      border: 1px solid var(--border);
      color: var(--text);
      text-decoration: none;
    }
    .nav-btn:hover {
      background: #f8fafc;
      transform: translateY(-1px);
    }
    .nav-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
  </style>
</head>
<body class="text-gray-800">
  <div id="app">
    <header class="glass fixed top-0 left-0 right-0 z-30">
      <div class="flex items-center justify-between px-6 h-16">
        <div class="flex items-center gap-3">
          <i class="fa fa-graduation-cap text-blue-500 text-xl"></i>
          <h1 class="font-bold text-lg hidden sm:block text-blue-900">学生管理系统</h1>
        </div>
        <div class="flex items-center gap-2">
          <a href="counselorleave.html" class="nav-btn active">
            <i class="fa fa-calendar-check-o"></i>
            <span class="hidden sm:inline">请假审核</span>
          </a>
          <a href="counselorwarn.html" class="nav-btn">
            <i class="fa fa-exclamation-triangle"></i>
            <span class="hidden sm:inline">学业预警</span>
          </a>
          <a href="counselorclassroom.html" class="nav-btn">
            <i class="fa fa-building"></i>
            <span class="hidden sm:inline">教室申请</span>
          </a>
          <a href="counselor.html" class="nav-btn">
            <i class="fa fa-home"></i>
            <span class="hidden sm:inline">返回首页</span>
          </a>
        </div>
      </div>
    </header>

    <!-- 主内容区 -->
    <main class="pt-20 p-6 max-w-6xl mx-auto">
      <div class="mb-8">
        <h2 class="text-3xl font-bold text-blue-900 mb-2">学生请假审核</h2>
        <div class="flex items-center gap-2 text-gray-500 text-sm">
          <a href="counselor.html" class="hover:text-blue-500">辅导员主页</a>
          <i class="fa fa-angle-right"></i>
          <span>学生请假审核</span>
        </div>
      </div>

      <!-- 筛选区域 -->
      <div class="card p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-gray-600 font-medium mb-2 text-sm">申请日期</label>
            <input type="date" class="input-base" v-model="filter.application_date">
          </div>
          <div>
            <label class="block text-gray-600 font-medium mb-2 text-sm">请假类型</label>
            <select class="input-base" v-model="filter.leave_type">
              <option value="">全部类型</option>
              <option value="sick">病假</option>
              <option value="personal">事假</option>
              <option value="emergency">紧急事假</option>
              <option value="other">其他</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-600 font-medium mb-2 text-sm">审批状态</label>
            <select class="input-base" v-model="filter.approval_status">
              <option value="">全部状态</option>
              <option value="pending">待审批</option>
              <option value="approved">已通过</option>
              <option value="rejected">已拒绝</option>
            </select>
          </div>
          <!-- 查询按钮 -->
          <div class="flex gap-4 md:col-span-3">
            <button class="btn btn-primary flex-1 justify-center" @click="queryApplications">
              <i class="fa fa-search"></i>查询
            </button>
            <button class="btn btn-outline flex-1 justify-center" @click="resetFilter">
              <i class="fa fa-refresh"></i>重置
            </button>
          </div>
        </div>
      </div>

      <!-- 申请列表 -->
      <div class="card overflow-hidden">
        <div class="p-6 border-b border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <h3 class="font-bold text-lg">请假申请列表 <span class="text-gray-400 font-normal text-sm">(共{{ total }}条申请)</span></h3>
          <div class="flex gap-3">
            <button class="btn btn-outline" @click="exportApplications">
              <i class="fa fa-download"></i><span class="hidden sm:inline">导出数据</span>
            </button>
          </div>
        </div>

        <!-- 表格 -->
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">申请单号</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">学生学号</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">学生姓名</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">班级</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">请假类型</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">请假时间</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">申请时间</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">状态</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              <tr class="table-row" v-for="(app, idx) in paginatedList" :key="app.application_id">
                <td class="px-4 py-3 text-sm font-medium">{{ app.application_no }}</td>
                <td class="px-4 py-3 text-sm">{{ app.student_id }}</td>
                <td class="px-4 py-3 text-sm">{{ app.student_name }}</td>
                <td class="px-4 py-3 text-sm">{{ app.class_name }}</td>
                <td class="px-4 py-3 text-sm">{{ typeMap[app.leave_type].text }}</td>
                <td class="px-4 py-3 text-sm">{{ app.leave_start_date }} 至 {{ app.leave_end_date }}</td>
                <td class="px-4 py-3 text-sm">{{ app.create_time }}</td>
                <td class="px-4 py-3">
                  <span :class="['badge', statusMap[app.approval_status].class]" class="status-badge">
                    <i :class="statusMap[app.approval_status].icon"></i>{{ statusMap[app.approval_status].text }}
                  </span>
                </td>
                <td class="px-4 py-3">
                  <button v-if="app.approval_status === 'pending'" class="btn btn-primary btn-sm" @click="openModal(app.application_id)">
                    <i class="fa fa-gavel"></i>审批
                  </button>
                  <button v-else class="btn btn-outline btn-sm" @click="viewDetails(app)">
                    <i class="fa fa-eye"></i>查看
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 分页 -->
        <div class="p-4 flex items-center justify-between text-sm text-gray-500">
          <span>显示 {{ (page - 1) * pageSize + 1 }} 至 {{ Math.min(page * pageSize, total) }} 条，共 {{ total }} 条</span>
          <div class="flex gap-1">
            <button class="px-3 py-1 rounded border border-gray-200 hover:bg-gray-50" :disabled="page === 1" @click="page--">
              <i class="fa fa-angle-left"></i>
            </button>
            <button v-for="p in pageButtons" :key="p" :class="['px-3 py-1 rounded border', p === page ? 'border-blue-500 bg-blue-500 text-white' : 'border-gray-200 hover:bg-gray-50']" @click="page = p">
              {{ p }}
            </button>
            <button class="px-3 py-1 rounded border border-gray-200 hover:bg-gray-50" :disabled="page === pageTotal" @click="page++">
              <i class="fa fa-angle-right"></i>
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- 审批模态框 -->
    <div v-if="modalVisible" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg max-w-md w-full p-6">
        <h3 class="text-lg font-bold mb-4">审批请假申请</h3>
        <div class="mb-4" v-if="modalData.application_no">
          <p class="text-sm text-gray-600 mb-2">申请单号：<span class="font-medium">{{ modalData.application_no }}</span></p>
          <p class="text-sm text-gray-600 mb-2">学生：<span class="font-medium">{{ modalData.student_id }} {{ modalData.student_name }}</span></p>
          <p class="text-sm text-gray-600 mb-2">班级：<span class="font-medium">{{ modalData.class_name }}</span></p>
          <p class="text-sm text-gray-600 mb-2">请假类型：<span class="font-medium">{{ typeMap[modalData.leave_type].text }}</span></p>
          <p class="text-sm text-gray-600 mb-2">请假时间：<span class="font-medium">{{ modalData.leave_start_date }} 至 {{ modalData.leave_end_date }}</span></p>
          <p class="text-sm text-gray-600 mb-4">请假事由：<span class="font-medium">{{ modalData.reason }}</span></p>

          <label class="block text-gray-600 font-medium mb-2 text-sm">审批意见</label>
          <textarea class="input-base" rows="3" v-model="modalComment" placeholder="请输入审批意见..."></textarea>
        </div>
        <div class="flex gap-3 justify-end">
          <button class="btn btn-outline" @click="modalVisible = false">取消</button>
          <button class="btn btn-danger" @click="handleReject">
            <i class="fa fa-times"></i>拒绝
          </button>
          <button class="btn btn-success" @click="handleApprove">
            <i class="fa fa-check"></i>通过
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          // 原始申请数据
          rawList: [
            { application_id: 1, application_no: 'LV2024110001', student_id: '2023001', student_name: '张三', class_name: '计算机科学与技术1班', leave_type: 'sick', leave_start_date: '2024-11-05', leave_end_date: '2024-11-07', reason: '感冒发烧，需要休息', create_time: '2024-11-01 14:30', approval_status: 'pending' },
            { application_id: 2, application_no: 'LV2024110002', student_id: '2023002', student_name: '李四', class_name: '软件工程2班', leave_type: 'personal', leave_start_date: '2024-11-06', leave_end_date: '2024-11-06', reason: '参加亲戚婚礼', create_time: '2024-11-01 15:45', approval_status: 'pending' },
            { application_id: 3, application_no: 'LV2024110003', student_id: '2023003', student_name: '王五', class_name: '网络工程1班', leave_type: 'emergency', leave_start_date: '2024-11-07', leave_end_date: '2024-11-09', reason: '家中突发急事', create_time: '2024-11-02 09:20', approval_status: 'approved' },
            { application_id: 4, application_no: 'LV2024110004', student_id: '2023004', student_name: '陈六', class_name: '信息安全2班', leave_type: 'other', leave_start_date: '2024-11-08', leave_end_date: '2024-11-08', reason: '参加学术竞赛', create_time: '2024-11-02 16:10', approval_status: 'rejected' },
            { application_id: 5, application_no: 'LV2024110005', student_id: '2023005', student_name: '刘七', class_name: '人工智能1班', leave_type: 'sick', leave_start_date: '2024-11-09', leave_end_date: '2024-11-10', reason: '肠胃炎需就医', create_time: '2024-11-03 11:30', approval_status: 'pending' },
            { application_id: 6, application_no: 'LV2024110006', student_id: '2023006', student_name: '赵老', class_name: '计算机科学与技术2班', leave_type: 'personal', leave_start_date: '2024-11-10', leave_end_date: '2024-11-11', reason: '办理身份证', create_time: '2024-11-03 14:00', approval_status: 'pending' },
            { application_id: 7, application_no: 'LV2024110007', student_id: '2023007', student_name: '钱教', class_name: '软件工程1班', leave_type: 'emergency', leave_start_date: '2024-11-11', leave_end_date: '2024-11-12', reason: '家人住院需陪护', create_time: '2024-11-04 10:20', approval_status: 'approved' }
          ],
          // 筛选条件
          filter: { application_date: '', leave_type: '', approval_status: '' },
          // 分页参数
          page: 1,
          pageSize: 5,
          // 存储查询后的结果
          queryResult: [],
          // 模态框相关
          modalVisible: false,
          modalData: {},
          modalComment: ''
        };
      },
      computed: {
        // 分页后的数据（基于查询结果）
        paginatedList() {
          const start = (this.page - 1) * this.pageSize;
          return this.queryResult.slice(start, start + this.pageSize);
        },
        // 总条数（基于查询结果）
        total() {
          return this.queryResult.length;
        },
        // 总页数
        pageTotal() {
          return Math.ceil(this.total / this.pageSize);
        },
        // 分页按钮列表（最多显示5个页码）
        pageButtons() {
          const max = 5;
          let start = Math.max(1, this.page - Math.floor(max / 2));
          let end = Math.min(this.pageTotal, start + max - 1);
          if (end - start < max - 1) start = Math.max(1, end - max + 1);
          return Array.from({ length: end - start + 1 }, (_, i) => start + i);
        },
        // 状态映射
        statusMap() {
          return {
            pending: { class: 'bg-orange-100 text-orange-700', icon: 'fa fa-clock-o', text: '待审批' },
            approved: { class: 'bg-green-100 text-green-700', icon: 'fa fa-check', text: '已通过' },
            rejected: { class: 'bg-red-100 text-red-700', icon: 'fa fa-times', text: '已拒绝' }
          };
        },
        // 请假类型映射
        typeMap() {
          return {
            sick: { text: '病假', class: 'bg-blue-100 text-blue-700' },
            personal: { text: '事假', class: 'bg-purple-100 text-purple-700' },
            emergency: { text: '紧急事假', class: 'bg-red-100 text-red-700' },
            other: { text: '其他', class: 'bg-gray-100 text-gray-700' }
          };
        }
      },
      mounted() {
        // 页面加载时默认查询全部数据
        this.queryApplications();
      },
      methods: {
        // 手动查询方法
        queryApplications() {
          // 重置到第一页
          this.page = 1;
          // 根据筛选条件过滤数据
          this.queryResult = this.rawList.filter(item => {
            if (this.filter.application_date && item.create_time.split(' ')[0] !== this.filter.application_date) return false;
            if (this.filter.approval_status && item.approval_status !== this.filter.approval_status) return false;
            if (this.filter.leave_type && item.leave_type !== this.filter.leave_type) return false;
            return true;
          });
        },
        // 打开审批模态框
        openModal(applicationId) {
          this.modalData = this.rawList.find(item => item.application_id === applicationId) || {};
          this.modalComment = '';
          this.modalVisible = true;
        },
        // 审批通过
        handleApprove() {
          if (!this.modalData.application_id) {
            this.modalVisible = false;
            return;
          }
          if (confirm('确定要通过此请假申请吗？')) {
            const targetIndex = this.rawList.findIndex(item => item.application_id === this.modalData.application_id);
            if (targetIndex !== -1) {
              this.rawList[targetIndex].approval_status = 'approved';
              this.rawList = [...this.rawList];
              // 审批后刷新查询结果
              this.queryApplications();
            }
            this.modalVisible = false;
          }
        },
        // 审批拒绝
        handleReject() {
          if (!this.modalData.application_id) {
            this.modalVisible = false;
            return;
          }
          if (!this.modalComment.trim()) {
            alert('请填写拒绝原因');
            return;
          }
          if (confirm('确定要拒绝此请假申请吗？')) {
            const targetIndex = this.rawList.findIndex(item => item.application_id === this.modalData.application_id);
            if (targetIndex !== -1) {
              this.rawList[targetIndex].approval_status = 'rejected';
              this.rawList = [...this.rawList];
              // 审批后刷新查询结果
              this.queryApplications();
            }
            this.modalVisible = false;
          }
        },
        // 查看详情
        viewDetails(app) {
          alert(`请假申请详情：
申请单号：${app.application_no}
学生：${app.student_name}（${app.student_id}）
班级：${app.class_name}
请假类型：${this.typeMap[app.leave_type].text}
请假时间：${app.leave_start_date} 至 ${app.leave_end_date}
请假事由：${app.reason}
状态：${this.statusMap[app.approval_status].text}`);
        },
        // 重置筛选条件
        resetFilter() {
          this.filter = { application_date: '', leave_type: '', approval_status: '' };
          // 重置后自动查询全部数据
          this.queryApplications();
        },
        // 导出数据
        exportApplications() {
          if (this.queryResult.length === 0) {
            alert('暂无符合条件的请假申请数据，无法导出');
            return;
          }

          const exportData = this.queryResult.map(app => ({
            申请单号: app.application_no,
            学生学号: app.student_id,
            学生姓名: app.student_name,
            班级: app.class_name,
            请假类型: this.typeMap[app.leave_type].text,
            请假开始日期: app.leave_start_date,
            请假结束日期: app.leave_end_date,
            请假事由: app.reason,
            申请提交时间: app.create_time,
            审批状态: this.statusMap[app.approval_status].text
          }));

          const workbook = XLSX.utils.book_new();
          const worksheet = XLSX.utils.json_to_sheet(exportData);
          XLSX.utils.book_append_sheet(workbook, worksheet, '请假申请记录');
          
          const fileName = `学生请假申请审核表_${new Date().toLocaleDateString()}.xlsx`;
          XLSX.writeFile(workbook, fileName);

          alert('数据导出成功！文件已下载到本地');
        }
      }
    }).mount('#app');
  </script>
</body>
</html>