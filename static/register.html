<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”¨æˆ·æ³¨å†Œ - æ ¡å›­ç®¡ç†ç³»ç»Ÿ</title>
  <style>
    :root {
      --primary-color: #4a6ee0;
      --primary-hover: #3a5ec0;
      --secondary-color: #6c757d;
      --success-color: #2ecc71;
      --error-color: #e74c3c;
      --border-radius: 8px;
      --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Microsoft YaHei', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 100%;
      max-width: 500px;
      padding: 40px 35px;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #333;
      font-weight: 600;
      font-size: 28px;
    }

    .logo {
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
      color: var(--primary-color);
      font-weight: bold;
    }

    .user-type-selector {
      display: flex;
      margin-bottom: 25px;
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 1px solid #e0e0e0;
      background-color: #f8f9fa;
    }

    .user-type-selector label {
      flex: 1;
      text-align: center;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .user-type-selector input[type="radio"] {
      display: none;
    }

    .user-type-selector input[type="radio"]:checked+span {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
    }

    .user-type-selector span {
      display: block;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .user-type-selector label:hover span {
      background-color: #e9ecef;
    }

    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
      font-size: 14px;
    }

    input,
    select {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 16px;
      transition: all 0.3s;
      background-color: #fff;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(74, 110, 224, 0.1);
    }

    input:disabled {
      background-color: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }

    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 14px;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s;
      margin-bottom: 15px;
    }

    .btn:hover {
      background-color: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background-color: var(--secondary-color);
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .btn-loading {
      position: relative;
      color: transparent;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-right-color: transparent;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .hidden {
      display: none !important;
    }

    .error-message {
      color: var(--error-color);
      font-size: 13px;
      margin-top: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .success-message {
      color: var(--success-color);
      font-size: 14px;
      margin-top: 5px;
      text-align: center;
      padding: 10px;
      background-color: #d4edda;
      border-radius: var(--border-radius);
    }

    .password-strength {
      margin-top: 5px;
      height: 4px;
      border-radius: 2px;
      background-color: #e0e0e0;
      overflow: hidden;
    }

    .password-strength-bar {
      height: 100%;
      transition: all 0.3s ease;
    }

    .strength-weak {
      background-color: #e74c3c;
      width: 33%;
    }

    .strength-medium {
      background-color: #f39c12;
      width: 66%;
    }

    .strength-strong {
      background-color: #2ecc71;
      width: 100%;
    }

    .password-toggle {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 14px;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 480px) {
      .container {
        padding: 30px 20px;
        margin: 10px;
      }

      h1 {
        font-size: 24px;
      }

      .user-type-selector {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo">æ ¡å›­ç®¡ç†ç³»ç»Ÿ</div>
    <h1>ç”¨æˆ·æ³¨å†Œ</h1>

    <div class="user-type-selector">
      <label>
        <input type="radio" name="userType" value="student" checked>
        <span>å­¦ç”Ÿ</span>
      </label>
      <label>
        <input type="radio" name="userType" value="teacher">
        <span>æ•™å¸ˆ</span>
      </label>
      <label>
        <input type="radio" name="userType" value="counselor">
        <span>è¾…å¯¼å‘˜</span>
      </label>
    </div>

    <form id="registerForm" novalidate>
      <!-- å…¬å…±å­—æ®µ -->
      <div class="form-group">
        <label for="name">å§“å</label>
        <input type="text" id="name" name="name" required placeholder="è¯·è¾“å…¥çœŸå®å§“å">
      </div>

      <div class="form-group">
        <label for="phone">æ‰‹æœºå·</label>
        <input type="tel" id="phone" name="phone" required placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·" pattern="[0-9]{11}">
      </div>

      <div class="form-group">
        <label for="password">å¯†ç </label>
        <div style="position: relative;">
          <input type="password" id="password" name="password" required minlength="6" placeholder="è‡³å°‘6ä½å¯†ç ">
          <button type="button" class="password-toggle" id="passwordToggle">ğŸ‘ï¸</button>
        </div>
        <div class="password-strength">
          <div class="password-strength-bar" id="passwordStrength"></div>
        </div>
      </div>

      <div class="form-group">
        <label for="confirmPassword">ç¡®è®¤å¯†ç </label>
        <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
        <div id="passwordError" class="error-message hidden">ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´</div>
      </div>

      <!-- å­¦ç”Ÿç‰¹å®šå­—æ®µ -->
      <div id="studentFields">
        <div class="form-group">
          <label for="studentId">å­¦å·</label>
          <input type="text" id="studentId" name="studentId" required>
        </div>

        <div class="form-group">
          <label for="classId">ç­çº§ID</label>
          <input type="text" id="classId" name="classId" required>
        </div>

        <div class="form-group">
          <label for="assignedCounselorId">è¾…å¯¼å‘˜ID</label>
          <input type="text" id="assignedCounselorId" name="assignedCounselorId" required>
        </div>

        <div class="form-group">
          <label for="headTeacherId">ç­ä¸»ä»»ID</label>
          <input type="text" id="headTeacherId" name="headTeacherId" required>
        </div>
      </div>

      <!-- æ•™å¸ˆç‰¹å®šå­—æ®µ -->
      <div id="teacherFields" class="hidden">
        <div class="form-group">
          <label for="teacherId">æ•™å¸ˆå·¥å·</label>
          <input type="text" id="teacherId" name="teacherId" required>
        </div>

        <div class="form-group">
          <label for="teacherRole">è§’è‰²</label>
          <select id="teacherRole" name="teacherRole" required>
            <option value="">è¯·é€‰æ‹©è§’è‰²</option>
            <option value="NORMAL">æ™®é€šæ•™å¸ˆ</option>
            <option value="HEAD_TEACHER">ç­ä¸»ä»»</option>
          </select>
        </div>

        <div class="form-group">
          <label for="teacherClassId">å…³è”ç­çº§ID</label>
          <input type="text" id="teacherClassId" name="teacherClassId">
        </div>
      </div>

      <!-- è¾…å¯¼å‘˜ç‰¹å®šå­—æ®µ -->
      <div id="counselorFields" class="hidden">
        <div class="form-group">
          <label for="counselorEmployeeId">è¾…å¯¼å‘˜å·¥å·</label>
          <input type="text" id="counselorEmployeeId" name="counselorEmployeeId" required>
        </div>

        <div class="form-group">
          <label for="department">æ‰€å±é™¢ç³»</label>
          <input type="text" id="department" name="department" required>
        </div>
      </div>

      <button type="submit" class="btn" id="submitBtn">æ³¨å†Œ</button>
      <a href="login.html">è¿”å›ç™»å½•ç•Œé¢</a>
    </form>

    <div id="successMessage" class="success-message hidden"></div>
  </div>

  <script>
    class RegisterManager {
      constructor() {
        this.init();
      }

      init() {
        this.bindEvents();
        this.showUserFields('student');
        this.updateTeacherClassIdField();
      }

      bindEvents() {
        // ç”¨æˆ·ç±»å‹åˆ‡æ¢
        document.querySelectorAll('input[name="userType"]').forEach(radio => {
          radio.addEventListener('change', (e) => {
            this.showUserFields(e.target.value);
          });
        });

        // æ•™å¸ˆè§’è‰²åˆ‡æ¢å¤„ç†
        document.getElementById('teacherRole').addEventListener('change', () => {
          this.updateTeacherClassIdField();
        });

        // å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢
        document.getElementById('passwordToggle').addEventListener('click', () => {
          this.togglePasswordVisibility();
        });

        // å®æ—¶å¯†ç å¼ºåº¦æ£€æµ‹
        document.getElementById('password').addEventListener('input', (e) => {
          this.checkPasswordStrength(e.target.value);
        });

        // å®æ—¶å¯†ç åŒ¹é…éªŒè¯
        document.getElementById('confirmPassword').addEventListener('input', () => {
          this.validatePasswordMatch();
        });

        // è¡¨å•æäº¤
        document.getElementById('registerForm').addEventListener('submit', (e) => {
          this.handleSubmit(e);
        });
      }

      showUserFields(userType) {
        // ç¦ç”¨æ‰€æœ‰éšè—å­—æ®µçš„éªŒè¯
        document.querySelectorAll('#studentFields input, #teacherFields input, #teacherFields select, #counselorFields input').forEach(input => {
          input.disabled = true;
          input.removeAttribute('required');
        });

        // éšè—æ‰€æœ‰å­—æ®µåŒºåŸŸ
        document.getElementById('studentFields').classList.add('hidden');
        document.getElementById('teacherFields').classList.add('hidden');
        document.getElementById('counselorFields').classList.add('hidden');

        // æ˜¾ç¤ºå¯¹åº”å­—æ®µåŒºåŸŸ
        if (userType === 'student') {
          document.getElementById('studentFields').classList.remove('hidden');
          // å¯ç”¨å­¦ç”Ÿå­—æ®µ
          document.querySelectorAll('#studentFields input').forEach(input => {
            input.disabled = false;
            input.setAttribute('required', 'true');
          });
        } else if (userType === 'teacher') {
          document.getElementById('teacherFields').classList.remove('hidden');
          document.querySelectorAll('#teacherFields input, #teacherFields select').forEach(input => {
            input.disabled = false;
            if (input.id !== 'teacherClassId') {
              input.setAttribute('required', 'true');
            }
          });
          this.updateTeacherClassIdField();
        } else if (userType === 'counselor') {
          document.getElementById('counselorFields').classList.remove('hidden');
          document.querySelectorAll('#counselorFields input').forEach(input => {
            input.disabled = false;
            input.setAttribute('required', 'true');
          });
        }
      }

      updateTeacherClassIdField() {
        const teacherRoleSelect = document.getElementById('teacherRole');
        const teacherClassIdInput = document.getElementById('teacherClassId');

        if (teacherRoleSelect.value === 'NORMAL') {
          teacherClassIdInput.disabled = true;
          teacherClassIdInput.removeAttribute('required');
          teacherClassIdInput.placeholder = 'æ™®é€šæ•™å¸ˆæ— éœ€å¡«å†™ç­çº§ID';
        } else {
          teacherClassIdInput.disabled = false;
          teacherClassIdInput.setAttribute('required', 'true');
          teacherClassIdInput.placeholder = '';
        }
      }

      togglePasswordVisibility() {
        const passwordInput = document.getElementById('password');
        const toggleButton = document.getElementById('passwordToggle');

        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          toggleButton.textContent = 'ğŸ”’';
        } else {
          passwordInput.type = 'password';
          toggleButton.textContent = 'ğŸ‘ï¸';
        }
      }

      checkPasswordStrength(password) {
        const strengthBar = document.getElementById('passwordStrength');
        let strength = 'weak';

        if (password.length >= 12) {
          strength = 'strong';
        } else if (password.length >= 8) {
          strength = 'medium';
        }

        strengthBar.className = `password-strength-bar strength-${strength}`;
      }

      validatePasswordMatch() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const errorElement = document.getElementById('passwordError');

        if (confirmPassword && password !== confirmPassword) {
          errorElement.classList.remove('hidden');
          return false;
        } else {
          errorElement.classList.add('hidden');
          return true;
        }
      }

      validateForm() {
        let isValid = true;

        // éªŒè¯å…¬å…±å­—æ®µ
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!name) {
          alert('è¯·è¾“å…¥å§“å');
          return false;
        }

        if (!this.validatePhone(phone)) {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·');
          return false;
        }

        if (password.length < 6) {
          alert('å¯†ç é•¿åº¦è‡³å°‘6ä½');
          return false;
        }

        if (!this.validatePasswordMatch()) {
          return false;
        }

        // éªŒè¯ç‰¹å®šå­—æ®µ
        const userType = document.querySelector('input[name="userType"]:checked').value;

        if (userType === 'student') {
          const studentId = document.getElementById('studentId').value.trim();
          const classId = document.getElementById('classId').value.trim();
          const counselorId = document.getElementById('assignedCounselorId').value.trim();
          const headTeacherId = document.getElementById('headTeacherId').value.trim();

          if (!studentId || !classId || !counselorId || !headTeacherId) {
            alert('è¯·å¡«å†™å®Œæ•´çš„å­¦ç”Ÿä¿¡æ¯');
            return false;
          }
        } else if (userType === 'teacher') {
          const teacherId = document.getElementById('teacherId').value.trim();
          const teacherRole = document.getElementById('teacherRole').value;
          const teacherClassId = document.getElementById('teacherClassId').value.trim();

          if (!teacherId || !teacherRole) {
            alert('è¯·å¡«å†™å®Œæ•´çš„æ•™å¸ˆä¿¡æ¯');
            return false;
          }

          if (teacherRole === 'HEAD_TEACHER' && !teacherClassId) {
            alert('ç­ä¸»ä»»å¿…é¡»å¡«å†™å…³è”ç­çº§ID');
            return false;
          }
        } else if (userType === 'counselor') {
          const counselorId = document.getElementById('counselorEmployeeId').value.trim();
          const department = document.getElementById('department').value.trim();

          if (!counselorId || !department) {
            alert('è¯·å¡«å†™å®Œæ•´çš„è¾…å¯¼å‘˜ä¿¡æ¯');
            return false;
          }
        }

        return true;
      }

      validatePhone(phone) {
        return /^1[3-9]\d{9}$/.test(phone);
      }

      async handleSubmit(e) {
        e.preventDefault();

        if (!this.validateForm()) {
          return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        this.setLoadingState(true);

        try {
          const formData = new FormData(document.getElementById('registerForm'));
          const userType = document.querySelector('input[name="userType"]:checked').value;

          // æ ¹æ®ç”¨æˆ·ç±»å‹æ„å»ºæ•°æ®å¯¹è±¡
          let userData = {
            name: formData.get('name'),
            phone: formData.get('phone'),
            password: document.getElementById('password').value,
            userType: userType
          };

          // æ ¹æ®ç”¨æˆ·ç±»å‹æ·»åŠ ç‰¹å®šå­—æ®µ
          if (userType === 'student') {
            userData.student_id = formData.get('studentId');
            userData.class_id = formData.get('classId');
            userData.counselor_id = formData.get('assignedCounselorId');
            userData.head_teacher_id = formData.get('headTeacherId');
          } else if (userType === 'teacher') {
            userData.teacher_id = formData.get('teacherId');
            userData.role = formData.get('teacherRole');
            if (userData.role === 'HEAD_TEACHER') {
              userData.class_id = formData.get('teacherClassId');
            }
          } else if (userType === 'counselor') {
            userData.counselor_id = formData.get('counselorEmployeeId');
            userData.department = formData.get('department');
          }

          // å‘é€æ³¨å†Œè¯·æ±‚åˆ°åç«¯
          const response = await fetch('/api/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
          });

          const data = await response.json();

          if (data.success) {
            this.showSuccessMessage();
          } else {
            throw new Error(data.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
          }

        } catch (error) {
          console.error('æ³¨å†Œé”™è¯¯:', error);
          alert(error.message);
        } finally {
          this.setLoadingState(false);
        }
      }

      setLoadingState(loading) {
        const submitBtn = document.getElementById('submitBtn');
        if (loading) {
          submitBtn.classList.add('btn-loading');
          submitBtn.disabled = true;
        } else {
          submitBtn.classList.remove('btn-loading');
          submitBtn.disabled = false;
        }
      }

      showSuccessMessage() {
        const successMessage = document.getElementById('successMessage');
        successMessage.textContent = 'æ³¨å†ŒæˆåŠŸï¼2ç§’åè·³è½¬åˆ°ç™»å½•é¡µé¢...';
        successMessage.classList.remove('hidden');

        // æ³¨å†ŒæˆåŠŸå2ç§’è·³è½¬åˆ°ç™»å½•é¡µé¢
        setTimeout(() => {
          window.location.href = '/login.html';
        }, 2000);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      new RegisterManager();
    });
  </script>
</body>

</html>